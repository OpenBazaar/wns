<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <title>WorfNS</title>
  <!-- css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.5.3/css/bulma.css">
  <link rel="shortcut icon" type="image/x-icon" href="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/129/name-badge_1f4db.png">
  <style>
    .box {
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

</head>

<body>

  <a href="https://github.com/OpenBazaar/wns" class="github-corner" aria-label="View source on Github">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
      aria-hidden="true">
      <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
      <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
        fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
      <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
        fill="currentColor" class="octo-body"></path>
    </svg>
  </a>
  <style>
    .github-corner:hover .octo-arm {
      animation: octocat-wave 560ms ease-in-out
    }

    @keyframes octocat-wave {
      0%,
      100% {
        transform: rotate(0)
      }
      20%,
      60% {
        transform: rotate(-25deg)
      }
      40%,
      80% {
        transform: rotate(10deg)
      }
    }

    @media (max-width:500px) {
      .github-corner:hover .octo-arm {
        animation: none
      }
      .github-corner .octo-arm {
        animation: octocat-wave 560ms ease-in-out
      }
    }
  </style>

  <div class="hero is-fullheight is-info is-bold">
    <div class="hero-body">
      <div class="container">
        <p style="text-align: center; font-size:100px;">ðŸ“›</p>
        <p class="title is-1" style="text-align: center;">WorfNS</p>
        <p class="subtitle is-3" style="text-align: center;">A simple naming service for OpenBazaar.</p>
        <br>
        <div class="box">
          <form id="searchHandle-form" @submit.prevent="searchForm">
            <div class="field has-addons">
              <div class="control is-expanded">
                <input class="input" type="text" name="searchQuery" placeholder="Find a handle (e.g. drwasho)" v-model="searchQuery">
              </div>
              <div class="control">
                <button type="submit" class="button is-primary">
                  Search
                </button>
              </div>
            </div>
          </form>

        </div>
        <div class="box">

          <!-- our signup form ===================== -->
          <form id="handleRegistration-form" @submit.prevent="processForm">
            <!-- handle -->
            <h5 class="title is-5" style="color: #000000">Register a handle</h5>
            <p class="subtitle is-6" style="color: #636363">Metamask required; registrations on Rinkeby network only.</p>
            <div class="field">
              <label class="label" style="color: #636363">Handle</label>
              <input type="text" class="input" name="handle" v-model="handle" required>
            </div>

            <!-- display name -->
            <div class="field">
              <label class="label" style="color: #636363">Display name</label>
              <input type="text" class="input" name="displayName" v-model="displayName">
            </div>

            <!-- image location -->
            <div class="field">
              <label class="label" style="color: #636363">Image location (URI)</label>
              <input type="text" class="input" name="imageLocation" v-model="imageLocation">
            </div>

            <!-- peerID -->
            <div class="field">
              <label class="label" style="color: #636363">peerID</label>
              <input type="text" class="input" name="peerID" v-model="peerID" required>
            </div>

            <!-- submit button -->
            <div class="field has-text-right">
              <button type="submit" class="button is-danger">
                Register
              </button>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
  <section class="hero is-light">
    <div class="hero-body">
      <div class="container">
        <h5 class="title is-5" style="color: #000000">Latest handles (Total count- <span id="totalHandles">0</span>)</h5>
        <!-- Registered handles ===================== -->
        <table class="table is-bordered is-striped is-narrow is-hoverable" id="handlesTable">
          <thead>
            <tr>
              <th style="font-size:1vw;">Handle</th>
              <th style="font-size:1vw;">peerId</th>
              <th style="font-size:1vw;">Owner</th>
            </tr>
          </thead>
          <tbody>
            <tr></tr>
          </tbody>
        </table>

        <h5 class="title is-5" style="color: #000000">My handles</h5>
        <!-- Registered handles ===================== -->
        <table class="table is-bordered is-striped is-narrow is-hoverable" id="myHandlesTable">
          <thead>
            <tr>
              <th style="font-size:1vw;">Handle</th>
              <th style="font-size:1vw;">peerId</th>
            </tr>
          </thead>
          <tbody>
            <tr></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</body>

<script>
  var totalHandleCount = 0;
  var rowToRemoveFromLatestTable = 1;

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use the browser's ethereum provider
    var provider = web3.currentProvider
  } else {
    // web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io"));
  }

  // Initialise WORFNS contract
  //// ABI
  let worfnsContractABI = web3.eth.contract([{ "constant": false, "inputs": [{ "name": "handle", "type": "string" }, { "name": "newName", "type": "string" }], "name": "changeDisplayName", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "handle", "type": "string" }, { "name": "_displayName", "type": "string" }, { "name": "_imageLocation", "type": "string" }, { "name": "_peerId", "type": "string" }], "name": "createHandle", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "handle", "type": "string" }, { "name": "peerId", "type": "string" }], "name": "changePeerId", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "owner", "type": "address" }, { "name": "handle", "type": "string" }, { "name": "_displayName", "type": "string" }, { "name": "_imageLocation", "type": "string" }, { "name": "_peerId", "type": "string" }], "name": "addHandle", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "address" }], "name": "superUsers", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "handle", "type": "string" }], "name": "isHandleAvailable", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "handle", "type": "string" }], "name": "removeHandle", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "handleName", "type": "string" }], "name": "getHandleInfo", "outputs": [{ "name": "owner", "type": "address" }, { "name": "handle", "type": "string" }, { "name": "displayName", "type": "string" }, { "name": "imageLocation", "type": "string" }, { "name": "peerId", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "handle", "type": "string" }, { "name": "newImageLocation", "type": "string" }], "name": "changeImageLocation", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "handle", "type": "string" }, { "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "name": "_superUsers", "type": "address[]" }], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }, { "indexed": false, "name": "peerId", "type": "string" }, { "indexed": true, "name": "owner", "type": "address" }], "name": "NewHandle", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }, { "indexed": false, "name": "displayName", "type": "string" }], "name": "NewDisplayName", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }, { "indexed": false, "name": "imageLocation", "type": "string" }], "name": "NewImageLocation", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }, { "indexed": false, "name": "peerId", "type": "string" }], "name": "NewPeerId", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }, { "indexed": true, "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "handle", "type": "string" }], "name": "HandleRemoved", "type": "event" }])
  //// Contract address
  let worfnsContract = worfnsContractABI.at('0xd81a7e253f7364e574dfa496a14149a89ab2d8b8');

  // Search for a handle
  const search = new Vue({
    el: '#searchHandle-form',

    // our data
    data: {
      searchQuery: ''
    },

    // our methods
    methods: {
      searchForm: function () {
        let searchQuery = this.searchQuery

        console.log("Data check =>", { searchQuery });

        worfnsContract.getHandleInfo(searchQuery, function (err, result) {
          if (result && result.constructor === Array && result[4] !== "") {
            console.log(JSON.stringify(result));
            alert('The peerID for ' + result[1] + ' is: ' + result[4])
          } else {
            alert('Handle not found. If you just registered your handle, it make take a minute or so to update.');
          }
        });
      }
    }
  });

  // Register a new handle
  const rego = new Vue({
    el: '#handleRegistration-form',

    // our data
    data: {
      handle: '',
      displayName: '',
      imageLocation: '',
      peerID: ''
    },

    // our methods
    methods: {
      processForm: function () {
        let account = web3.eth.accounts[0]
        let handle = this.handle;
        let displayName = this.displayName;
        let imageLocation = this.imageLocation;
        let peerID = this.peerID;

        
        console.log("Data check =>", { handle, displayName, imageLocation, peerID });

        worfnsContract.isHandleAvailable(this.handle, function (err, result) {
          if (result) {
            console.log('Great news, handle is available!');
            worfnsContract.createHandle(handle, displayName, imageLocation, peerID, function (err, result) {
              if (result) {
                alert('Handle registered!');
              } else {
                alert('Error occurred');
              }
            });
          } else {
            console.log('Sorry, this handle is taken :(');
            alert('Sorry, this handle is taken, or some other error occurred. Make sure Metamask is installed and it is set to the Rinkeby network.')
          }
        });
      }
    }
  });

  // Display the latest registered handles
  var newHandleEvent = worfnsContract.NewHandle({}, { fromBlock: 2898449, toBlock: 'latest' });
  newHandleEvent.watch(function (error, result) {
    console.log("Event fired", error, result);

    if(!error){
      var handle = result.args.handle;
      var peerId = result.args.peerId;
      var owner = result.args.owner;

      if (peerId.length > 0) {
        totalHandleCount = totalHandleCount + 1;
        if(totalHandleCount > 20){
          $('#row' +rowToRemoveFromLatestTable).remove();
          rowToRemoveFromLatestTable++;
        }

        $("#totalHandles").text(totalHandleCount);

        var $tr = $('<tr id =row' +totalHandleCount+ '>').append(
          $('<td style="font-size:1vw;">').text(handle),
          $('<td style="font-size:1vw;">').text(peerId),
          $('<td style="font-size:1vw;">').text(owner),
        ).appendTo('#handlesTable');

        if(owner == web3.eth.accounts[0]){
         var $tr = $('<tr>').append(
          $('<td style="font-size:1vw;">').text(handle),
          $('<td style="font-size:1vw;">').text(peerId),
        ).appendTo('#myHandlesTable');
        }
      }
      else{
        console.log("Peer Id missing for handle", handle);
      }
    }else {
      console.log('Handle not found');
    }

  });

</script>

</html>

